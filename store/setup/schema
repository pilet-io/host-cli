#!/bin/bash

#>

cat <<EOF | store_sys
DROP SCHEMA IF EXISTS system CASCADE;
CREATE SCHEMA system;
SET search_path to system;

CREATE TABLE host (
  host TEXT PRIMARY KEY,
  ram INT,
  cpu INT,
  disk INT
);

CREATE TABLE net4 (
  id TEXT GENERATED ALWAYS AS ( left(md5(type||host),4) ) STORED,
  type TEXT default 'public',
  host TEXT REFERENCES host,
  address TEXT,
  subnet INT default 32,
  template TEXT default 'none',
  PRIMARY KEY (id)
);

CREATE TABLE net6 (
  id TEXT GENERATED ALWAYS AS ( left(md5(type||host),3) ) STORED,
  type TEXT default 'public',
  host TEXT REFERENCES host,
  address TEXT,
  subnet INT default 64,
  template TEXT default 'none',
  PRIMARY KEY (id)
);

CREATE TABLE vm (
  id TEXT GENERATED ALWAYS AS ( left(md5(name||host),6) ) STORED,
  name TEXT,
  host TEXT REFERENCES host,
  profile TEXT,
  PRIMARY KEY (id)
);

CREATE TABLE address (
  seq INT,
  host TEXT REFERENCES host,
  vm_name TEXT,
  ip4 TEXT,
  ip6 TEXT,
  PRIMARY KEY (seq, host)
);

CREATE FUNCTION populate_address(p_host TEXT) RETURNS INT
AS \$\$
DECLARE
   v_template4 TEXT;
   v_template6 TEXT;
BEGIN
  SELECT template INTO v_template4 FROM net4 WHERE host = p_host and type = 'vm';
  IF NOT FOUND THEN
    RAISE 'NET4 not found for host %', p_host;
  END IF;

  SELECT template INTO v_template6 FROM net6 WHERE host = p_host;
  IF NOT FOUND THEN
    RAISE 'NET6 not found for host %', p_host;
  END IF;

  FOR index IN 10..100 LOOP
    INSERT INTO address (seq,host,ip4,ip6)
    VALUES (index, p_host,
      replace(v_template4,'*',index::text),
      replace(v_template6,'*',index::text));
  END LOOP;

  return 0;
end;
\$\$ LANGUAGE PLPGSQL;

CREATE FUNCTION register_vm(p_host TEXT, p_vm_name TEXT, p_profiles TEXT) RETURNS TEXT
AS \$\$
DECLARE
  v_seq INT;
  v_ip4 TEXT;
  v_ip6 TEXT;
BEGIN
  INSERT INTO system.vm (name, host, profile)
  VALUES (p_vm_name, p_host, p_profiles);

  SELECT seq INTO v_seq FROM system.address a JOIN generate_series(10,100) as sq ON sq = a.seq
  WHERE host = p_host and vm is null LIMIT 1;

  UPDATE system.address SET vm_name = p_vm_name
  WHERE host = p_host AND seq = v_seq;

  SELECT ip4, ip6 INTO v_ip4, v_ip6
  FROM system.address WHERE seq = v_seq AND host = p_host;

  return v_ip4 || ',' || v_ip6;
end;
\$\$ LANGUAGE PLPGSQL;


INSERT INTO host (host,ram,cpu,disk) VALUES
('fs1701.pilet.cloud', 128, 32, 6000),
('fs1702.pilet.cloud', 128, 32, 6000),
('fs1703.pilet.cloud', 128, 32, 6000);

INSERT INTO net4 (host,address) VALUES
('fs1701.pilet.cloud', '142.132.204.215'),
('fs1702.pilet.cloud', '142.132.206.130'),
('fs1703.pilet.cloud', '94.130.54.233');

INSERT INTO net4 (type,host,address,subnet,template) VALUES
('vm','fs1701.pilet.cloud', '192.168.1.1', 16, '192.168.1.*'),
('vm','fs1702.pilet.cloud', '192.168.2.1', 16, '192.168.2.*'),
('vm','fs1703.pilet.cloud', '192.168.3.1', 16, '192.168.3.*');

INSERT INTO net6 (host,address,template) VALUES
('fs1701.pilet.cloud', '2a01:4f8:261:5103::2','2a01:4f8:261:5103::*'),
('fs1702.pilet.cloud', '2a01:4f8:261:52da::2','2a01:4f8:261:52da::*'),
('fs1703.pilet.cloud', '2a01:4f8:10b:2c49::2','2a01:4f8:10b:2c49::*');

SELECT populate_address('fs1701.pilet.cloud');
SELECT populate_address('fs1702.pilet.cloud');
SELECT populate_address('fs1703.pilet.cloud');

EOF