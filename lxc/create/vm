#!/bin/bash

#> [name]=some [profile]=md

lxc config show $NAME > /dev/null 2>&1
if [ $? -eq 0 ]; then
  echo "Container $NAME already exists"
  exit 1
fi

OPTIONS=""
for profile in ${PROFILE/,/ }; do
  OPTIONS="$OPTIONS --profile $profile"
done

store_vm_remove $NAME > /dev/null

lxc init ubuntu:24.04 $NAME --vm $OPTIONS
store_vm_add $NAME $PROFILE
lxc start $NAME

if [[ $PROFILE =~ "vlan" ]]; then
  while true; do
    sleep 2s
    IPV6=$(lxc exec $NAME ip addr 2>/dev/null | grep 2a01 | awk '{print $2}')
    IPV4=$(lxc exec $NAME ip addr 2>/dev/null | grep 192. | awk '{print $2}')
    echo -n "."
    IPV6=${IPV6/\/64/}
    IPV4=${IPV4/\/16/}
    if [ ! -z "$IPV6" ] && [ ! -z "$IPV4" ]; then
      echo ""
      echo "IPs are $IPV4, $IPV6"
      store_vm_add_ip $NAME $IPV4 $IPV6 > /dev/null
      break
    fi
  done
else
  while true; do
    sleep 2s
    IPV6=$(lxc exec $NAME ip addr 2>/dev/null | grep 2a01 | awk '{print $2}')
    IPV4=$(lxc exec $NAME ip addr 2>/dev/null | grep 'inet 10' | awk '{print $2}')
    echo -n "."
    IPV6=${IPV6/\/64/}
    IPV4=${IPV4/\/24/}
    if [ ! -z "$IPV6" ] && [ ! -z "$IPV4" ]; then
      echo ""
      echo "IPs are $IPV4, $IPV6"
      store_vm_add_ip $NAME $IPV4 $IPV6 > /dev/null
      break
    fi
  done
fi

cat<<EOF | lxc shell $NAME
git clone https://github.com/pilet-io/vm-cli.git
mv /root/vm-cli /root/cli
echo "export PATH=\$PATH:/root/cli" >> /root/.profile
EOF