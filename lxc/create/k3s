#!/bin/bash

#> [name]=? [profile]=lg

with lxc create vm --name $NAME --profile $PROFILE
if [ $? -ne 0 ]; then
  echo "Failed creating container $NAME"
  exit 1
fi

with lxc install k3s-master --name $NAME

IP6=$(store_get_vm_addr6 $NAME)

cat <<EOF > /etc/traefik/services/${NAME}.yaml
http:
  routers:
    route-$NAME:
      rule: "Host(\`${NAME}.pilet.site\`)"
      tls:
        certResolver: resolver0
        domains:
          - main: "*.pilet.site"
      service: service-$NAME
      priority: 1000
      entryPoints:
        - https

  services:
    service-$NAME:
      loadBalancer:
        servers:
          - url: "http://[$IP6]:80"
EOF

cat <<EOF > /etc/traefik/services/${NAME}-6443.yaml
tcp:
  routers:
    route-$NAME-k8s:
      rule: "HostSNI(\`${NAME}.pilet.site\`)"
      tls:
        passthrough: true
      service: service-$NAME-k8s
      priority: 1000
      entryPoints:
        - k8s

  services:
    service-$NAME-k8s:
      loadBalancer:
        servers:
          - address: "[$IP6]:6443"
EOF

dns_create_record CNAME $NAME pilet.site $SYS_HOSTNAME
